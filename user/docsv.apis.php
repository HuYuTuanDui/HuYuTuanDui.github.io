<?php include "doconn.php";?><?php include "dosess.php";?><?phpini_set("max_execution_time", "45");$stime=microtime(true);$datedir = "./csvfiles/";$ts="ib".date("YmdHis");$il = $_POST['ys'];if(!pr($il)){webalert("请正确输入价格后再提交001。","docsvs.php?back=ff");}$ix = 0;$fg = "-{$ks}-";if(strlen($ck)<2){$ix++;}else{$fg .= "{$ck}-";}if(strlen($xd)<2){$ix++;}else{$fg .= "{$xd}-";}$iy = 3-$ix;function ui($fl,$kb){if($kb=="UTF-8"){$fl = tu($fl);}else{$kb = "gb2312";$fl = charaget($fl);}$fl = ml($fl);return $fl;}include "docsv.clas.php";	//包含一个文件上传类$up = new fileupload;$up -> set("path", $datedir);$up -> set("maxsize", 5000000); //上传文件大小限制$up -> set("allowtype", array("csv"));$up -> set("israndname", false);if($up -> upload("pic")){$up = $up->getFileName();$files = $datedir.$up;if(!file_exists($files)){webalert("文件上传存储失败!请尝试重新上传。","docsvs.php?back=ff");}$ii=0;$iae=0;$un = 0;$fl =  file_get_contents($files);$kb = yl($fl);$file = fopen($files,'r');while ($data = fgetcsv($file)){$ii++;$io=0;$sf = count($data);if($sf<$iy){ webalert("上传数据至少{$iy}列，详情看上传页面说明。","docsvs.php?back=yd");}if($ii=="1"){$tn =$data;$ye="-";for($ik=0;$ik<$iy;$ik++){$fq=ui($tn[$ik],$kb);$fq = preg_replace('/^(\xef\xbb\xbf)/', '', $fq);//删除Bom$ye .= $fq."-";}if($fg==$ye){//前列列标题}else{//webalert("前{$iy}列列标题（{$fg}<>{$ye}）不符合要求。","docsvs.php?back=ti");webalert("前{$iy}列列标题请使用{$fg}!","docsvs.php?back=ti");}}else{$wi = ui($data[0],$kb);$sc = preg_replace("/[^A-Z^a-z^0-9^_^@^\-^\.^\x{4e00}-\x{9fa5}]+/u", '', $wi);$ap = "";$ke = ui($data[1],$kb);$ia = ui($data[2],$kb);if(!pr($ia)){webalert("检查第三列是否都是价格数字比如第{$ii}行!","doadda.php");}else{$un = $un+$ia;}if($ii."_"=="2_"){$uz = "('{$ts}','{$sc}','{$ke}','{$ia}')";}else{$uz .= ",('{$ts}','{$sc}','{$ke}','{$ia}')";}}}//统一价格小数位数$il = number_format($il,2);$un = number_format($un,2);if($il !== $un){webalert("导入失败：第三列统计价格和输入总金额不一样({$il}<>{$un})!","doadda.php");}$dosqls = "INSERT INTO `kudi` (`rn`,`le`,`fe`,`ge`) VALUES {$uz}";$echos=$db->query($dosqls);//echo "<div>$dosqls</div>";if($echos){$ve = "导入成功!进入批次{$ts}查看导入结果";}else{$ve = "导入异常!进入批次{$ts}查看导入结果";}if (!unlink($files))  {}else{}webalert($ve,"douser.php?keys={$ts}");} else {//获取上传失败以后的错误提示$er = $up->getErrorMsg();webalert($er,"docsvs.php?back=er");}$etime=microtime(true);		//获取程序执行结束的时间$total=$etime-$stime;		//计算差值